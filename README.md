# awesome-works

## 写在前面：


2025年8月24日：测试智能公司的M2000 控制器，SP18，内置`CH343`，USB线不能长于8米。

2025年8月23日：zat600v653z 测试平移落与防摇摆没有问题。17.3m 和 31.3m。长臂长平移起费劲。

2025年8月23日：F501的`persistent`备份`retain`变量，在`codesys`刷完后，需要重启控制器才能写入备份，重启再次刷`codesys`则还需要绑定一次，绑定完记得重启。此外，无论绑定多少次，写入`retain`的值不变。**电控所不支持发布。**

2025年8月20日：`INT` 的有符号发送；

```pascal
// 方式一
array_Tx_2A1[7]:=USINT_TO_BYTE(INT_TO_USINT(tracking_control_value MOD 256));
array_Tx_2A1[8]:=USINT_TO_BYTE(INT_TO_USINT(tracking_control_value / 256));  // 该行有效，INT_TO_USINT。
array_Tx_2A1[8]:=SINT_TO_BYTE(INT_TO_SINT(tracking_control_value / 256));  // 对比上一行，SINT_TO_BYTE 更容易看出是有符号数。
```

```pascal
// 方式二
array_Tx_29C[1]:=UINT_TO_BYTE(INT_TO_UINT(can_goal_high_value) MOD 256);
array_Tx_29C[2]:=UINT_TO_BYTE(INT_TO_UINT(can_goal_high_value) / 256);
```

2025年8月5日：

- 在双 `task` 的 `Plc Logic` 下， `IecTaskGetFirst` 获取顺序由内部id确定，不是命名排序，应该使用 `IecTaskGetCurrent` 。

2025年8月4日：ztc1300vs863，8552 与 8554 车，用错了过放标志位，大吨位的过放标志位是 `OR` 之后的变量，而小车不是。:bangbang:

2025年5月&7月：

- zat600v653z #16725-F501车的问题，标准版无法获取当前工况。
- 60吨显示器的电源在刷完程序后会自动关闭，需按下按键面板的电源键。与 zat1300vs763 相同。
- 60z 和 60e 的球形手柄较为特殊，其值的解析目前应该没有死区，吊载平移的开关（method)中，删除右手柄纵向值不为零则 `test := 4;` ，解决平移的意外跳出。
- Codesys 刷写会 `4K retain` 区会擦除，导致 `GPS` 解绑，从而锁车。利用 persistent 变量解决。
- 吊载平移的卷扬速度振荡，目前仅60z和60e，改写卷扬期望速度来自变幅速度，同时修改控制周期为 `32` 和 调整位置差系数 `K_position_rise` 和 `K_position_fall`。
- 根据 60z 的代码封装为库。测试了自定义商店网址的可行性，但需要一个服务器。
- PCAN 高级用法：
  - 采用 symbol 变量直接解释报文，可以不用写 filter。
  - 写 macro 发送变化数字刻度。例如，发送变化的回转角度模拟回转。
  - 利用 panel 切换报文数值，不用再来回修改 message。
- 报文差异统计 智能化搭载协议-外：
  - 平移的报文差异较大，由于旧报文的存在本身不统一。
  - 防摇摆的报文差异无，因 C01 未搭载。
- 利用 python 的 fft 处理塔臂的摆动周期数据，fft 在同工况下的数据同一性非常好。华测手簿，可利用图层细化记录。
- 60e 与 110e 修改，[周期组](#周期组)发送数据，避免丢包，充分利用控制器的空间与时隙资源。
  - 基数5，程序的 `interval` 在10-12ms可用；50ms一组、100ms三组、200ms四组、500ms十五组。
  - 基数4，程序的 `interval` 在13-15ms可用；50ms一组、100ms三组、200ms四组、500ms五组。
  - 基数3，程序的 `interval` 在16ms可用；50ms一组、100ms两组、200ms两组、500ms五组。
- `Codesys` 代码注释中的批量日期修正。reg 搜索。`(?<=\(\*)\d{8}(?=.*? by 唐金峰\*\))`
- ztc3500vs863 不搭载平移，未调用平移，`derrick_sub` 中的 `smooth` 所乘的系数是0，应声明赋值为1。补丁到了400-1，60z/e、110e、300g吨。

2025年5月5日：

- zat9000v863 #339车左右防摇摆电流限制为 塔臂的电流。后续再更改。
- 另外一台车出现误刷，由于防摇摆I期 `pid` 累加电流小于零时，控制器 `real_to_uint` 死机。 查明于 @2025年7月1日。
- `real_to_uint` 的 解决办法是， limit/max 限定；或 `subrange` ， 其使用要配合 checkRangeUsinged 和 checkRangeSigned。
- 900吨停止搭载。

2025年4月28日：zat4000vs863-1 #2024车，还存有油门锁定-防摇摆功能的开启方式。高家坤已删除。

~~2025年4月25日 重新修改协议：~~:interrobang:

- 4BB 只发送5个字节，对应吊载平移；增加吊载平移跳出的两个类型。
- 3C0 只发送4个字节，对应辅助防摇摆。
- 4BB 发送条件为卷扬传感器心跳。 3C0，发送条件为回转、卷扬传感器心跳在且参数状态启用。周期 400 ms。
- 上述心跳变量与 237、 238 参数无关，表明传感器必须在，而不是在传感器无数据（未收发或未安装）的非标配情形。
- 8个字节从前往后，当前不发送空字节，可以**临时测试使用或版本迭代更新**。

2025年4月16日：

- :heavy_exclamation_mark:ztc1300vs863 #8552 与 #8554 车，回转编码器防拆代码未写，回转编码器心跳错误不会写为 `TRUE`；
- ztc1300vs863 的卷扬编码器标定程序已经从400-1替换，不兼容原来的19A；
- ztc1300vs863 的回转编码器程序替换，替换且兼容中回传感器的标定；大吨位与 162 相关，写入起始为 324 ，2个字节。
- zat4000vs863-1 中回传感器的标定，与参数 240 相关；写入起始为 480，2个字节。

2025年4月10日：

- zat4000vs863-1 此前测试已测试完毕，代码 retain 变量 real 四字节的数组，高家坤直接注释代码（断电丢失），今日协调修改精度 DINT ，保留三个小数点。
- 已经重新拉回指针引用。:copyright:

2025年4月8日：

- 1300vs763 力限器 1.4 为防拆，测试发现卷扬编码器标定代码异常（混乱），已修改。
- **取力问题未发现原因，控制器为5040D，认为是显示器锁车。**
- 编码器装于 CAN4.

2025年4月1日：zat4000vs863-1 #2023车，防拆特性，当拆除两个编码器，需要修改4号控制器的 237 与 238参数。

## 搭载记录

- 高端化试验中：
  - zat600v653z 测试完成，
  - zat600v653e 等待测试，
  - zat1100v753e 待成台测试，
  - zat1200e 未开始，
  - zat3000e 未开始。

- 新（平移＋防摇摆2.0）搭载车型：
  - 车型 ztc1300vs863 两台，#8554和 #8552；（无 `autowinch_error`）
  - 车型 zat4000vs863-1 一台，#2024；（有 `autowinch_error`）
- 此前（平移＋防摇摆1.0）搭载车型：
  - ZAT2400V863；
  - ZAT2600V853N；
  - ZAT3000VS863（#2047准备场外搭载）；
  - ZAT3000VS863-1；
  - ZAT4000VS863（停产）。
- 此前平移搭载车型：
  - zat6000v863、（有 `autowinch_error`）
  - zat7000v863，已更新程序待测试；（无 `autowinch_error`）
- 衍生车型：
  - ztc3500vs863 不搭载；zat9000v863 不搭载；（有 `autowinch_error`）
  - zat3000v753g 待测试；

- 完成临时测试车辆（拆物资）：
  - ztc1300vs863#8379、zat4000vs863-1#2023、zat9000v863#449;

## 周期组

对于去年探索的控制器知识分享一下，本次测试使用`ifm`控制器，特点是刷写程序快，支持断点单步测试。

1. 仿真设置 Task 的 interval（间隔）为 15ms时，真实周期为 16ms。
2. 控制器设置 Task 为15 ms，真实周期就是 15ms。
3. Blink产生的定时器，在发送正常时，其发送周期误差取决于Blink的Low、High时长，最小误差0，最大误差 =2x程序周期-2。
   对于100ms 的发送周期，blink的高50ms、低50ms，则因为 ceiling(50/15)=4，则真实发送周期为15x4x2=120ms。
4. Ton定时器，可以方便实现互质错位发送，其发送周期的误差（真实与理论之差），最小误差=1x程序周期+1，最大误差=3x程序间隔-1。
   对于100ms的发送周期，会产生单个斜坡，则因为 celling（100/15）=7，第7个程序周期输出bool值1，第8个周期输出反相给输入复位，第9个周期再次使能，则真实发送周期为 15*(7+2)=135ms。

总结，Ton 周期设置若想同步开启且异步发送，则必须两个周期值的差值超过1个程序周期；Blink 则需要差2个程序周期（或调整low与high值）。这种根据大数互质实现错位发送，把丢包时机拖延在一个很长的时间，相当于实现了无丢包发送。而利用周期组，可以铺满时隙，完全错开，完全无丢包（前提是循环时隙资源足以发送所有内容）。因此，还需要咨询或测试CAN发送缓存最大值，以确定单个步次可以发送多少ID报文。

## 常见物资信息

卷扬编码器物资：

- posital：其芯片可以等效替代ifm，每转分辨率可读可写，可设12bit，即4096，最大16bit，即65536:ad值发送28bit：（已测试目对比过）
- ifm：`1020202555/B-钢丝绳圈筒角度测量系统`，其每转分辨率可读可写，最大12bit，即4096:ad值发送24bit：（已测试过）
- 迈新（非ce）：`1021406366-电子三圈过放`，其每转分辨率可调（sdo），最大12bit，即4096；ad值发送24bit；
  是否可以等效替代ifm。？？？无需启动指令，默认CAN总线ID可能是1A0，分辨率4096，默认逆时针计数。
- 迈新（ce）：`1021405887/B-电子卷扬保护器`，分辨率1000，不可调：ad值发送24bit。

回转编码器物资：

- 鼎立：1012-回转检测器 `1021405885`，每转分辨率可设12bit，最大13 bit，即8192；ad值发送25bit，标定最大值=大齿x小齿x4096。
- 鼎立：1214-回转检测器 `1021405502/B`，每转分辨率可设12bit，最大13 bit，即8192;ad值发送25bit，标定最大值=大齿x小齿x4096。

## 防摇摆I期 vs II期差异 @2025年：

- 年前130吨，角度 anti_angle 与can总线一致（方向相同），joystick_transform 输出未取负，右转时-期望速度为正，anti实际速度为负。操纵无异常。II期。
- 3月上：700吨，角度anti_angle 取can总线值，未放大10倍，joystick_transform 输出未取负时时，操纵无异常。I期。
- 上周：900吨，角度 anti_angle 与can总线反向（关于360度互补），joystick_transform 输出取负时，操纵无异常。预警弧长反向。
- 3月：900吨待正在测试。改角度 anti_angle 与can总线一致（方向相同），joystick_transform 输出未取负时，操纵反向，右转时向左，anti 速度为负，但期望速度为正（pid 没有抑制，可以回转）。再次改回上周代码，但在弧长输出取符号。
- 400-1 照例I期。
- 130 照例II期。130吨，角度 anti_angle 与can总线一致（方向相同）。
- 防摇摆II期，900吨调试问题：
  - 单次防摇摆结束时，存在历经弧长没有清除的现象。因为不必要的复位。上车没有回转则保持橙色状态灯。
  - 回转漂移时长与回转急停距离两位有效数字，除0外。10.4‘ 屏幕不绘制底盘信息。
- 旧版本的防摇摆资料中，
  - 【开：回转传感器 关：回转编码器】与【防摇摆参数显示】都需要设置；
  - 手柄上的油门锁定按钮，在【防摇摆参数显示】开时，被借用为防摇摆的开启开关；按下按钮，满足条件时，防摇摆的状态灯会变绿（两种状态）;
  - 吊钩高度标定对应的‘钢丝绳长度损耗标定’需要先开启【卷扬随动 扰度补偿】；

